#!/bin/bash
set -e  # Exit immediately if any command fails
trap 'rc=$?; echo "$(date): FAILED cmd: $BASH_COMMAND (rc=$rc)" >> "$LOG_FILE"' ERR

# Log file for debugging
LOG_FILE="script_debug.log"
echo "Script started at $(date)" > $LOG_FILE

# Function to log messages
log() {
    echo "$(date): $1" >> $LOG_FILE
}

# Publish NetworkMonitor for linux-x64
log "Publishing NetworkMonitor for linux-x64"
dotnet publish NetworkMonitor.csproj -c Release -r linux-x64 --self-contained true >> $LOG_FILE 2>&1
if [ $? -ne 0 ]; then
    log "Failed to publish NetworkMonitor for linux-x64"
    exit 1
fi
log "Successfully published NetworkMonitor for linux-x64"

# Publish NetworkMonitor-Maui-Android for android
log "Publishing NetworkMonitor-Maui-Android for android"
dotnet publish NetworkMonitor-Maui-Android.csproj -c Release -r android --self-contained true >> $LOG_FILE 2>&1
if [ $? -ne 0 ]; then
    log "Failed to publish NetworkMonitor-Maui-Android for android"
    exit 1
fi
log "Successfully published NetworkMonitor-Maui-Android for android"

# Copy files from linux-x64 to android publish directory
log "Copying files from linux-x64 to android publish directory"
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/System* ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/PuppeteerSharp.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/RestSharp.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1

# Allow missing Nito* safely
shopt -s nullglob
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Nito* ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1 || true
shopt -u nullglob

cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Nanoid.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/mscorlib.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/netstandard.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/HtmlAgilityPack.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/FluentFTP.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Betalgo.Ranul.OpenAI.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/BouncyCastle.Cryptography.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Microsoft.Extensions* ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1 || true
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Microsoft.IdentityModel* ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1 || true
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Microsoft.Bcl.AsyncInterfaces.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Microsoft.CodeAnalysis.CSharp.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Microsoft.CodeAnalysis.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Microsoft.CSharp.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/Markdig.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1
# difference here use the android NetworkMonitor.dll later overwritten for linux kept for andoid.
cp ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/NetworkMonitor.dll ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish >> $LOG_FILE 2>&1

rm -f ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish/_Microsoft.Android.Resource.Designer.dll
log "Successfully copied files to android publish directory"

log "Copying files to NetworkMonitorProcessor"
cp ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish/* ~/code/NetworkMonitorProcessor/openssl/bin/dlls >> $LOG_FILE 2>&1
# use the linux-x64 NetworkMonitor.dll
cp ~/code/NetworkMonitorLib/bin/Release/net10.0/linux-x64/publish/NetworkMonitor.dll  ~/code/NetworkMonitorProcessor/openssl/bin/dlls >> $LOG_FILE 2>&1
log "Successfully copied files to android publish directory"

if [ $? -ne 0 ]; then
    log "Failed to copy files to NetworkMonitorProcessor"
    exit 1
fi
log "Successfully copied files to NetworkMonitorProcessor"

# Copy files to QuantumSecure
log "Copying files to QuantumSecure"
cp ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish/* ~/code/QuantumSecure/Resources/Raw/dlls >> $LOG_FILE 2>&1
# Guard chmod when folder is briefly empty
shopt -s nullglob; chmod 755 ~/code/QuantumSecure/Resources/Raw/dlls/*; shopt -u nullglob
if [ $? -ne 0 ]; then
    log "Failed to copy files to QuantumSecure"
    exit 1
fi
log "Successfully copied files to QuantumSecure"

# Run create-manifest for QuantumSecure
log "Running create-manifest for QuantumSecure"
~/code/QuantumSecure/Resources/Raw/dlls/create-manifest >> $LOG_FILE 2>&1
if [ $? -ne 0 ]; then
    log "Failed to run create-manifest for QuantumSecure"
    exit 1
fi
log "Successfully ran create-manifest for QuantumSecure"

# Copy files to NetworkMonitorAgent
log "Copying files to NetworkMonitorAgent"
cp ~/code/NetworkMonitorLib/bin/Release/net10.0-android/android/publish/* ~/code/NetworkMonitorAgent/Resources/Raw/dlls >> $LOG_FILE 2>&1
# Guard chmod when folder is briefly empty
shopt -s nullglob; chmod 755 ~/code/NetworkMonitorAgent/Resources/Raw/dlls/*; shopt -u nullglob
if [ $? -ne 0 ]; then
    log "Failed to copy files to NetworkMonitorAgent"
    exit 1
fi
log "Successfully copied files to NetworkMonitorAgent"

# Run create-manifest for NetworkMonitorAgent
log "Running create-manifest for NetworkMonitorAgent"
~/code/NetworkMonitorAgent/Resources/Raw/dlls/create-manifest >> $LOG_FILE 2>&1
if [ $? -ne 0 ]; then
    log "Failed to run create-manifest for NetworkMonitorAgent"
    exit 1
fi
log "Successfully ran create-manifest for NetworkMonitorAgent"

log "Script completed successfully"
echo "Script completed successfully. Check $LOG_FILE for details."
exit 0

